<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniSocial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Simple animation for new posts */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        /* Style for a liked button */
        .liked-button {
            color: #EF4444; /* red-500 */
        }
        .liked-button svg {
            fill: #EF4444;
        }
    </style>
<style>.meta-counts{display:none !important;}</style>
</head>
<body class="bg-slate-100 font-sans">

    <div id="auth-container" class="container mx-auto max-w-md p-6 mt-20 bg-white rounded-lg shadow-xl">
        <div id="auth-error" class="text-red-600 text-sm mb-4" role="alert"></div>
        <h1 class="text-4xl font-bold text-indigo-600 text-center mb-6">MiniSocial</h1>
        
        <form id="signup-form" class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Create Account</h2>
            <div>
                <label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-200">Sign Up</button>
        </form>

        <div class="my-6 flex items-center justify-center">
            <span class="border-b w-1/5 lg:w-1/4"></span>
            <span class="text-xs text-center text-gray-500 uppercase mx-3">or</span>
            <span class="border-b w-1/f lg:w-1/4"></span>
        </div>

        <form id="login-form" class="space-y-4">
            <h2 class="text-2xl font-semibold text-gray-800">Log In</h2>
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-slate-800 text-white font-bold py-2 px-4 rounded-full hover:bg-slate-700 transition duration-200">Log In</button>
        </form>
        
        <div class="my-6 flex items-center justify-center">
            <span class="border-b w-1/5 lg:w-1/4"></span>
            <span class="text-xs text-center text-gray-500 uppercase mx-3">or</span>
            <span class="border-b w-1/5 lg:w-1/4"></span>
        </div>

        <button id="google-signin" class="w-full flex items-center justify-center space-x-2 bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full hover:bg-gray-50 transition duration-200">
            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            <span>Sign in with Google</span>
        </button>
    </div>

    <div id="username-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-4">Create your profile</h2>
            <p class="text-gray-600 mb-4">You need a unique username to continue.</p>
            <div id="username-error" class="text-red-600 text-sm mb-4" role="alert"></div>
            <form id="username-form">
                <div>
                    <label for="username-input" class="block text-sm font-medium text-gray-700">Username</label>
                    <div class="mt-1 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">@</span>
                        <input type="text" id="username-input" required placeholder="your_username" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300">
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-700 transition duration-200">Save and Enter</button>
            </form>
        </div>
    </div>


    <div id="app-container" class="hidden container mx-auto max-w-7xl p-4 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

        <aside class="md:col-span-1 md:sticky top-6 h-screen">
            <div class="bg-white p-4 rounded-lg shadow-sm space-y-6">
                <h1 class="text-3xl font-bold text-indigo-600">MiniSocial</h1>

                <nav>
                    <ul class="space-y-2">
                        <li>
                            <a href="#" data-target="content-home" class="nav-link flex items-center space-x-3 text-lg font-semibold text-gray-800 p-2 rounded-lg bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                                <span>Home</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-discover" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m0 10V7m0 10l-6-3" /></svg>
                                <span>Discover</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-link-profile" data-target="content-profile" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <span>Profile</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-messages" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                                <span>Messages</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-target="content-settings" class="nav-link flex items-center space-x-3 text-lg font-medium text-gray-600 hover:text-indigo-600 p-2 rounded-lg hover:bg-slate-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span>Settings</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <button id="sidebar-post-button" class="w-full bg-indigo-600 text-white font-bold text-lg py-3 rounded-full hover:bg-indigo-700 transition duration-200">
                    Post
                </button>

                <div class="border-t pt-4 mt-6">
                    <div id="sidebar-profile-button" class="flex items-center space-x-3 cursor-pointer rounded-lg p-2 -ml-2 hover:bg-slate-100">
                        <img id="user-avatar" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <div>
                            <p id="user-displayname" class="font-semibold text-gray-800">Your Name</p>
                            <p id="user-handle" class="text-sm text-gray-500">@yourhandle</p>
                        </div>
                    </div>
                    <button id="logout-button" class="w-full mt-4 text-sm text-center text-gray-600 hover:text-indigo-600">Log Out</button>
                </div>
            </div>
        </aside>

        <main class="col-span-1 md:col-span-2 space-y-6">

            <div id="content-home" class="content-panel space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <div class="flex items-start space-x-3">
                        <img id="post-user-avatar" src="https://placehold.co/40x40/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                        <textarea id="post-textarea" class="w-full p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" rows="3" placeholder="What's happening?"></textarea>
                    </div>
                    <div id="post-error" class="text-red-600 text-sm mt-2 text-right" role="alert"></div>
                    <div class="flex justify-end mt-3">
                        <button id="post-button" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-200 disabled:opacity-50">
                            Post
                        </button>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-gray-800">Your Home Feed</h2>
                <div id="feed-container-home" class="space-y-6">
                    </div>
            </div>

            <div id="content-discover" class="content-panel hidden space-y-6">
                <h2 class="text-2xl font-bold text-gray-800 p-4 bg-white rounded-lg shadow-sm">Discover All Posts</h2>
                <div id="feed-container-discover" class="space-y-6">
                    </div>
            </div>

            <div id="content-profile" class="content-panel hidden space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <img id="profile-page-avatar" src="https://placehold.co/80x80/E0E7FF/4F46E5?text=U" alt="User Avatar" class="w-20 h-20 rounded-full border-4 border-white shadow-md">
                            <div>
                                <h2 id="profile-page-username" class="text-3xl font-bold text-gray-900">Username</h2>
                                <p id="profile-page-handle" class="text-lg text-gray-500">@handle</p>
                            </div>
                        </div>
                        <button id="profile-follow-button" class="hidden mt-4 sm:mt-0 w-full sm:w-auto bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 transition duration-200">
                            Follow
                        </button>
                    </div>
                    <div class="flex space-x-6 mt-6 border-t pt-4">
                        <div>
                            <span id="profile-following-count" class="font-bold text-lg">0</span>
                            <span class="text-gray-600">Following</span>
                        </div>
                        <div>
                            <span id="profile-followers-count" class="font-bold text-lg">0</span>
                            <span class="text-gray-600">Followers</span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="font-medium">User ID:</p>
                        <p id="profile-page-uid" class="text-gray-500 text-sm break-all"></p>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Posts</h3>
                <div id="profile-feed-container" class="space-y-6">
                    </div>
            </div>

            <div id="content-messages" class="content-panel hidden bg-white rounded-lg shadow-sm h-[80vh]">
                <div class="grid grid-cols-1 md:grid-cols-3 h-full">
                    
                    <div class="md:col-span-1 border-r border-gray-200 h-full flex flex-col">
                        <h2 class="text-2xl font-bold text-gray-800 p-4 border-b">Conversations</h2>
                        <div id="dm-conversation-list" class="flex-1 overflow-y-auto">
                            <p class="p-4 text-gray-500">Loading conversations...</p>
                        </div>
                    </div>
                    
                    <div id="dm-chat-view" class="md:col-span-2 h-full flex flex-col hidden">
                        <h2 id="dm-chat-header" class="text-xl font-semibold text-gray-800 p-4 border-b">Select a conversation</h2>
                        
                        <div id="message-log" class="flex-1 p-4 space-y-4 overflow-y-auto bg-slate-50">
                            </div>
                        
                        <form id="dm-form" class="p-4 border-t flex space-x-3 bg-white">
                            <input type="text" id="dm-input" placeholder="Select a conversation to message..." class="flex-1 p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" disabled>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-200" disabled>Send</button>
                        </form>
                    </div>

                    <div id="dm-chat-placeholder" class="md:col-span-2 h-full flex items-center justify-center bg-slate-50">
                         <p class="text-gray-500">Select a conversation to start chatting.</p>
                    </div>

                </div>
            </div>
            <div id="content-settings" class="content-panel hidden bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Settings</h2>
                <p class="text-gray-600">This is where you could change your password, update notification preferences, etc.</p>
                <p class="mt-4 font-medium">Your Email:</p>
                <p id="settings-email" class="text-gray-700"></p>
                <p class="font-medium mt-2">Your Username:</p>
                <p id="settings-username" class="text-gray-700"></p>
            </div>

        </main>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            getDocs,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp, 
            runTransaction,
            where,
            increment,
            writeBatch,
            limit,
            updateDoc
        } from 'https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js';
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

        // --- 1. FIREBASE CONFIGURATION ---
        
        const firebaseConfig = {
          apiKey: "AIzaSyD-47gtfyUV75JPV03nqoMle4URzFK2B3E",
          authDomain: "nety-a602c.firebaseapp.com",
          projectId: "nety-a602c",
          storageBucket: "nety-a602c.firebasestorage.app",
          messagingSenderId: "874189944569",
          appId: "1:874189944569:web:d254db7f3841cf0ad2d428",
          measurementId: "G-6SE8GF9MD0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // --- 2. GLOBAL STATE ---
        let currentUser = null;
        let currentUserProfile = null;
        let currentUserLikedPosts = new Set();
        let unsubscribeHomeFeed = null;
        let unsubscribeDiscoverFeed = null;
        let unsubscribeProfileFeed = null;
        
        // NEW DM STATE
        let currentChatPartner = null;
        let unsubscribeConversation = null;

        // --- 3. DOM ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const usernameModal = document.getElementById('username-modal');

        // Auth Forms
        const signupForm = document.getElementById('signup-form');
        const loginForm = document.getElementById('login-form');
        const googleSigninBtn = document.getElementById('google-signin');
        const logoutButton = document.getElementById('logout-button');
        const authError = document.getElementById('auth-error');

        // Username Modal
        const usernameForm = document.getElementById('username-form');
        const usernameInput = document.getElementById('username-input');
        const usernameError = document.getElementById('username-error');

        // Main App
        const postButton = document.getElementById('post-button');
        const postTextarea = document.getElementById('post-textarea');
        const postError = document.getElementById('post-error');
        const homeFeedContainer = document.getElementById('feed-container-home');
        const discoverFeedContainer = document.getElementById('feed-container-discover');
        
        // NEW DM Elements
        const dmConversationList = document.getElementById('dm-conversation-list');
        const dmChatView = document.getElementById('dm-chat-view');
        const dmChatPlaceholder = document.getElementById('dm-chat-placeholder');
        const dmChatHeader = document.getElementById('dm-chat-header');
        const dmForm = document.getElementById('dm-form');
        const dmInput = document.getElementById('dm-input');
        const dmFormButton = dmForm.querySelector('button[type="submit"]');
        const messageLog = document.getElementById('message-log');

        // UI Elements
        const userAvatar = document.getElementById('user-avatar');
        const postUserAvatar = document.getElementById('post-user-avatar');
        const userDisplayname = document.getElementById('user-displayname');
        const userHandle = document.getElementById('user-handle');
        const sidebarProfileButton = document.getElementById('sidebar-profile-button');

        // Profile Page Elements
        const profilePage = document.getElementById('content-profile');
        const profileAvatar = document.getElementById('profile-page-avatar');
        const profileUsername = document.getElementById('profile-page-username');
        const profileHandle = document.getElementById('profile-page-handle');
        const profileFollowButton = document.getElementById('profile-follow-button');
        const profileFollowingCount = document.getElementById('profile-following-count');
        const profileFollowersCount = document.getElementById('profile-followers-count');
        const profileUid = document.getElementById('profile-page-uid');
        const profileFeedContainer = document.getElementById('profile-feed-container');

        // Settings Page Elements
        const settingsEmail = document.getElementById('settings-email');
        const settingsUsername = document.getElementById('settings-username');
        
        // --- 4. AUTH STATE CONTROLLER ---
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkUserProfile(user);
            } else {
                currentUser = null;
                currentUserProfile = null;
                showAuthUI();
            }
        });

        async function checkUserProfile(user) {
            const userRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                currentUserProfile = docSnap.data();
                await initializeAppUI(user, currentUserProfile);
            } else {
                authContainer.classList.add('hidden');
                appContainer.classList.add('hidden');
                usernameModal.classList.remove('hidden');
            }
        }

        function showAuthUI() {
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            usernameModal.classList.add('hidden');
            
            // Unsubscribe from all real-time listeners
            if (unsubscribeHomeFeed) unsubscribeHomeFeed();
            if (unsubscribeDiscoverFeed) unsubscribeDiscoverFeed();
            if (unsubscribeProfileFeed) unsubscribeProfileFeed();
            if (unsubscribeConversation) unsubscribeConversation(); // NEW
            currentChatPartner = null; // NEW
        }

        async function initializeAppUI(user, profile) {
            // 1. Populate sidebar user info
            userDisplayname.textContent = profile.username;
            userHandle.textContent = `@${profile.username}`;
            const avatarUrl = user.photoURL || `https://placehold.co/40x40/E0E7FF/4F46E5?text=${profile.username.charAt(0).toUpperCase()}`;
            userAvatar.src = avatarUrl;
            postUserAvatar.src = avatarUrl;

            // 2. Populate settings page
            settingsEmail.textContent = user.email;
            settingsUsername.textContent = `@${profile.username}`;
            
            // 3. Load user's liked posts into memory for quick UI checks
            await loadUserLikedPosts(user.uid);

            // 4. Show the app
            authContainer.classList.add('hidden');
            usernameModal.classList.add('hidden');
            appContainer.classList.remove('hidden');
            navigateTo("content-home"); // Start on Home

            // 5. Load dynamic content
            loadFollowingFeed(user.uid);
            loadDiscoverFeed();
            // loadDMs(user.uid); // *** REMOVED - DM logic is now handled by navigation ***
        }

        // --- 5. AUTHENTICATION FUNCTIONS ---

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = signupForm['signup-email'].value;
            const password = signupForm['signup-password'].value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                signupForm.reset();
                authError.textContent = '';
            } catch (error) {
                console.error("Signup Error:", error);
                authError.textContent = error.message;
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginForm.reset();
                authError.textContent = '';
            } catch (error) {
                console.error("Login Error:", error);
                authError.textContent = error.message;
            }
        });

        googleSigninBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                authError.textContent = '';
            } catch (error) {
                console.error("Google Signin Error:", error);
                authError.textContent = error.message;
            }
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // --- 6. USERNAME CREATION ---

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim().toLowerCase();
            if (username.length < 3) {
                usernameError.textContent = 'Username must be at least 3 characters.';
                return;
            }
            if (!/^[a-z0-9_]+$/.test(username)) {
                usernameError.textContent = 'Username can only contain lowercase letters, numbers, and underscores.';
                return;
            }

            const user = auth.currentUser;
            const usernameRef = doc(db, 'usernames', username);
            const userRef = doc(db, 'users', user.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const usernameDoc = await transaction.get(usernameRef);
                    if (usernameDoc.exists()) {
                        throw new Error("This username is already taken.");
                    }
                    
                    transaction.set(usernameRef, { uid: user.uid });
                    
                    const newUserProfile = {
                        username: username,
                        email: user.email || '',
                        uid: user.uid,
                        createdAt: serverTimestamp(),
                        photoURL: user.photoURL || '',
                        followingCount: 0,
                        followersCount: 0
                    };
                    transaction.set(userRef, newUserProfile);
                    
                    currentUserProfile = newUserProfile;
                });

                usernameError.textContent = '';
                await initializeAppUI(user, currentUserProfile);

            } catch (error) {
                console.error("Username Save Error:", error);
                usernameError.textContent = error.message;
            }
        });

        // --- 7. POSTING (FIRESTORE) ---

        postButton.addEventListener('click', async () => {
            postButton.disabled = true;
            const postText = postTextarea.value.trim();
            if (postText && postText.length <= 1000 && currentUser && currentUserProfile) {
                try {
                    await addDoc(collection(db, "posts"), {
                        text: postText,
                        userId: currentUser.uid,
                        username: currentUserProfile.username,
                        userPhotoURL: currentUser.photoURL || '',
                        createdAt: serverTimestamp(),
                        likeCount: 0,
                        commentCount: 0
                    });
                    postTextarea.value = '';
                    postError.textContent = '';
                } catch (error) {
                    console.error("Post Error:", error);
                    postError.textContent = `Error creating post: ${error.message}`;
                }
            } else if (postText.length > 1000) {
                postError.textContent = 'Post is too long (max 1000 chars).';
            } else {
                postError.textContent = 'Post cannot be empty.';
            }
            postButton.disabled = false;
        });

        // --- 8. LOADING FEEDS & POSTS ---

        async function loadFollowingFeed(userId) {
            if (unsubscribeHomeFeed) unsubscribeHomeFeed();

            const followingCol = collection(db, "users", userId, "following");
            const followingSnapshot = await getDocs(followingCol);
            
            const followedUserIds = [userId]; 
            followingSnapshot.forEach(doc => {
                followedUserIds.push(doc.id);
            });

            let q;
            if (followedUserIds.length > 0) {
                 q = query(
                    collection(db, "posts"), 
                    where("userId", "in", followedUserIds.slice(0, 30)),
                    orderBy("createdAt", "desc"),
                    limit(50)
                );
            }
           
            if (!q) {
                 homeFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Follow users to see their posts here. Check out the Discover tab!</p>';
                 return;
            }

            unsubscribeHomeFeed = onSnapshot(q, (snapshot) => {
                homeFeedContainer.innerHTML = '';
                if (snapshot.empty) {
                    homeFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">No posts from you or the users you follow yet.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const post = doc.data();
                    const postElement = createPostElement(doc.id, post);
                    homeFeedContainer.appendChild(postElement);
                });
            }, (error) => {
                console.error("Error loading home feed:", error);
                homeFeedContainer.innerHTML = '<p class="text-red-500 text-center">Error loading home feed. **Have you created the Firestore indexes?**</p>';
            });
        }

        function loadDiscoverFeed() {
            if (unsubscribeDiscoverFeed) unsubscribeDiscoverFeed();

            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(50));
            
            unsubscribeDiscoverFeed = onSnapshot(q, (snapshot) => {
                discoverFeedContainer.innerHTML = '';
                if (snapshot.empty) {
                    discoverFeedContainer.innerHTML = '<p class="text-gray-500 text-center">No posts yet. Be the first!</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const post = doc.data();
                    const postElement = createPostElement(doc.id, post);
                    discoverFeedContainer.appendChild(postElement);
                });
            }, (error) => {
                console.error("Error loading discover feed:", error);
                discoverFeedContainer.innerHTML = '<p class="text-red-500 text-center">Error loading discover feed.</p>';
            });
        }

        function loadProfileFeed(userId) {
            if (unsubscribeProfileFeed) unsubscribeProfileFeed();

            const q = query(
                collection(db, "posts"), 
                where("userId", "==", userId),
                orderBy("createdAt", "desc"),
                limit(50)
            );
            
            unsubscribeProfileFeed = onSnapshot(q, (snapshot) => {
                profileFeedContainer.innerHTML = '';
                if (snapshot.empty) {
                    profileFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">This user has no posts yet.</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const post = doc.data();
                    const postElement = createPostElement(doc.id, post);
                    profileFeedContainer.appendChild(postElement);
                });
            }, (error) => {
                console.error("Error loading profile feed:", error);
                profileFeedContainer.innerHTML = '<p class="text-red-500 text-center">Error loading this user\'s posts. **Have you created the Firestore indexes?**</p>';
            });
        }
        
        function createPostElement(postId, post) {
            const article = document.createElement('article');
            article.className = 'bg-white p-4 rounded-lg shadow-sm animate-fade-in';
            article.dataset.postId = postId;
            article.dataset.userId = post.userId;

            const date = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleString() : 'Just now';
            const avatarUrl = post.userPhotoURL || `https://placehold.co/40x40/E0E7FF/4F46E5?text=${post.username.charAt(0).toUpperCase()}`;

            const header = document.createElement('div');
            header.className = 'flex items-center space-x-3';
            
            const avatarImg = document.createElement('img');
            avatarImg.src = avatarUrl;
            avatarImg.alt = `${post.username}'s avatar`;
            avatarImg.className = 'w-10 h-10 rounded-full cursor-pointer';
            avatarImg.onclick = () => showProfile(post.userId);

            const meta = document.createElement('div');
            const nameP = document.createElement('p');
            nameP.className = 'font-semibold text-gray-800 cursor-pointer hover:underline';
            nameP.textContent = post.username || 'Unknown';
            nameP.onclick = () => showProfile(post.userId);

            const infoP = document.createElement('p');
            infoP.className = 'text-sm text-gray-500';
            infoP.textContent = `@${post.username || 'unknown'} · ${date}`;

            meta.appendChild(nameP);
            meta.appendChild(infoP);
            header.appendChild(avatarImg);
            header.appendChild(meta);

            const paragraph = document.createElement('p');
            paragraph.className = 'mt-4 text-gray-700 text-lg whitespace-pre-wrap';
            paragraph.textContent = post.text || '';

            const footer = document.createElement('div');
            footer.className = 'flex justify-around items-center mt-4 pt-3 border-t';

            // Like Button
            const likeBtn = document.createElement('button');
            const isLiked = currentUserLikedPosts.has(postId);
            likeBtn.className = `flex items-center space-x-2 text-gray-500 hover:text-red-500 group ${isLiked ? 'liked-button' : ''}`;
            likeBtn.setAttribute('aria-label', 'Like post');
            likeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.636l1.318-1.318a4.5 4.5 0 116.364 6.364L12 20.364l-7.682-7.682a4.5 4.5 0 010-6.364z" /></svg>`;
            
            const likeCount = document.createElement('span');
            likeCount.className = 'text-sm like-count';
            likeCount.textContent = post.likeCount || 0;
            likeBtn.appendChild(likeCount);
            
            likeBtn.addEventListener('click', () => {
                const currentlyLiked = currentUserLikedPosts.has(postId);
                toggleLike(postId, currentlyLiked);
            });

            // Comment Button
            const commentBtn = document.createElement('button');
            commentBtn.className = 'flex items-center space-x-2 text-gray-500 hover:text-indigo-500 group';
            commentBtn.setAttribute('aria-label', 'Comment on post');
            commentBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>`;
            
            const commentCount = document.createElement('span');
            commentCount.className = 'text-sm comment-count';
            commentCount.textContent = post.commentCount || 0;
            commentBtn.appendChild(commentCount);
            
            commentBtn.addEventListener('click', () => toggleCommentSection(postId));

            footer.appendChild(likeBtn);
            footer.appendChild(commentBtn);

            const commentSection = document.createElement('div');
            commentSection.id = `comments-section-${postId}`;
            commentSection.className = 'hidden mt-4 pt-4 border-t';

            const commentList = document.createElement('div');
            commentList.id = `comments-list-${postId}`;
            commentList.className = 'space-y-3 mb-4 max-h-60 overflow-y-auto';
            
            const commentForm = document.createElement('form');
            commentForm.id = `comment-form-${postId}`;
            commentForm.className = 'flex items-start space-x-3';
            
            const commentAvatar = document.createElement('img');
            commentAvatar.src = userAvatar.src;
            commentAvatar.className = 'w-9 h-9 rounded-full';
            
            const commentInput = document.createElement('input');
            commentInput.type = 'text';
            commentInput.placeholder = 'Write a comment...';
            commentInput.className = 'flex-1 p-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400';
            commentInput.name = 'commentText';

            const commentSubmitBtn = document.createElement('button');
            commentSubmitBtn.type = 'submit';
            commentSubmitBtn.className = 'bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200';
            commentSubmitBtn.textContent = 'Reply';

            commentForm.appendChild(commentAvatar);
            commentForm.appendChild(commentInput);
            commentForm.appendChild(commentSubmitBtn);

            commentForm.addEventListener('submit', (e) => handleCommentSubmit(e, postId));

            commentSection.appendChild(commentList);
            commentSection.appendChild(commentForm);

            article.appendChild(header);
            article.appendChild(paragraph);
            article.appendChild(footer);
            article.appendChild(commentSection);

            return article;
        }


        // --- 9. LIKE & COMMENT FUNCTIONS ---

        async function loadUserLikedPosts(userId) {
            currentUserLikedPosts.clear();
            const q = query(collection(db, "users", userId, "likedPosts"));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => {
                currentUserLikedPosts.add(doc.id);
            });
        }

        async function toggleLike(postId, isLiked) {
            if (!currentUser) return;

            const postRef = doc(db, "posts", postId);
            const userLikeRef = doc(db, "users", currentUser.uid, "likedPosts", postId);
            const postLikeRef = doc(db, "posts", postId, "likes", currentUser.uid);

            const batch = writeBatch(db);

            if (isLiked) {
                batch.delete(userLikeRef);
                batch.delete(postLikeRef);
                batch.update(postRef, { likeCount: increment(-1) });
                currentUserLikedPosts.delete(postId);
            } else {
                batch.set(userLikeRef, { likedAt: serverTimestamp() });
                batch.set(postLikeRef, { 
                    userId: currentUser.uid, 
                    username: currentUserProfile.username, 
                    likedAt: serverTimestamp() 
                });
                batch.update(postRef, { likeCount: increment(1) });
                currentUserLikedPosts.add(postId);
            }

            try {
                await batch.commit();
            } catch (error) {
                console.error("Error toggling like:", error);
                if (isLiked) currentUserLikedPosts.add(postId);
                else currentUserLikedPosts.delete(postId);
            }
        }
        
        function updateLikeUI(postId, isLiked) {
            const postElement = document.querySelector(`article[data-post-id="${postId}"]`);
            if (postElement) {
                const likeBtn = postElement.querySelector('button[aria-label="Like post"]');
                const likeCountEl = postElement.querySelector('.like-count');
                const currentCount = parseInt(likeCountEl.textContent);

                if (isLiked) {
                    likeBtn.classList.add('liked-button');
                    likeCountEl.textContent = currentCount + 1;
                } else {
                    likeBtn.classList.remove('liked-button');
                    likeCountEl.textContent = currentCount - 1;
                }
            }
        }
        
        async function toggleCommentSection(postId) {
            const commentSection = document.getElementById(`comments-section-${postId}`);
            if (commentSection) {
                const isHidden = commentSection.classList.toggle('hidden');
                if (!isHidden) {
                    await loadCommentsOnce(postId);
                    commentSection.querySelector('input[name="commentText"]').focus();
                }
            }
        }
        
        async function loadCommentsOnce(postId) {
            const listElement = document.getElementById(`comments-list-${postId}`);
            if (!listElement || listElement.dataset.loaded === 'true') {
                return;
            }

            listElement.innerHTML = '<p class="text-gray-500 text-sm">Loading comments...</p>';
            listElement.dataset.loaded = 'true';

            const q = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "asc"));
            const snapshot = await getDocs(q);

            listElement.innerHTML = '';
            if (snapshot.empty) {
                listElement.innerHTML = '<p class="text-gray-500 text-sm text-center">No comments yet.</p>';
            } else {
                snapshot.forEach(doc => {
                    listElement.appendChild(createCommentElement(doc.data()));
                });
            }
        }
        
        function createCommentElement(comment) {
            const div = document.createElement('div');
            div.className = 'flex items-start space-x-3';
            
            const avatarUrl = comment.userPhotoURL || `https://placehold.co/36x36/E0E7FF/4F46E5?text=${comment.username.charAt(0).toUpperCase()}`;
            const avatar = document.createElement('img');
            avatar.src = avatarUrl;
            avatar.className = 'w-9 h-9 rounded-full cursor-pointer';
            avatar.onclick = () => showProfile(comment.userId);
            
            const content = document.createElement('div');
            content.className = 'flex-1 bg-slate-100 rounded-lg p-3';
            
            const name = document.createElement('p');
            name.className = 'text-sm font-semibold text-gray-800 cursor-pointer hover:underline';
            name.textContent = comment.username;
            name.onclick = () => showProfile(comment.userId);

            const text = document.createElement('p');
            text.className = 'text-sm text-gray-700';
            text.textContent = comment.text;
            
            content.appendChild(name);
            content.appendChild(text);
            div.appendChild(avatar);
            div.appendChild(content);
            return div;
        }
        
        async function handleCommentSubmit(e, postId) {
            e.preventDefault();
            if (!currentUser) return;
            
            const form = e.target;
            const input = form.commentText;
            const text = input.value.trim();
            
            if (!text) return;
            
            form.querySelector('button[type="submit"]').disabled = true;

            const newComment = {
                text: text,
                userId: currentUser.uid,
                username: currentUserProfile.username,
                userPhotoURL: currentUser.photoURL || '',
                createdAt: serverTimestamp()
            };

            const postRef = doc(db, "posts", postId);
            const newCommentRef = doc(collection(db, "posts", postId, "comments"));
            const batch = writeBatch(db);

            try {
                batch.set(newCommentRef, newComment);
                batch.update(postRef, { commentCount: increment(1) });
                await batch.commit();

                const listElement = document.getElementById(`comments-list-${postId}`);
                if (listElement.dataset.loaded === 'true') {
                    const noComments = listElement.querySelector('p.text-center');
                    if (noComments) noComments.remove();
                    
                    listElement.appendChild(createCommentElement({
                        ...newComment,
                        createdAt: { toDate: () => new Date() }
                    }));
                }
                
                const postElement = document.querySelector(`article[data-post-id="${postId}"]`);
                if(postElement) {
                    const countEl = postElement.querySelector('.comment-count');
                    countEl.textContent = parseInt(countEl.textContent) + 1;
                }
                input.value = '';
                
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("Error adding comment. Please try again.");
            }
            form.querySelector('button[type="submit"]').disabled = false;
        }

        // --- 10. PROFILE & FOLLOWING FUNCTIONS ---

        async function showProfile(userId) {
            navigateTo("content-profile");
            
            const currentFollowButton = document.getElementById('profile-follow-button');
            profileUsername.textContent = 'Loading...';
            profileHandle.textContent = '...';
            profileFeedContainer.innerHTML = '<p class="text-gray-500 text-center p-4">Loading posts...</p>';
            currentFollowButton.classList.add('hidden');

            const userRef = doc(db, "users", userId);
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                profileUsername.textContent = 'User not found';
                profileHandle.textContent = '';
                profileFeedContainer.innerHTML = '';
                return;
            }

            const profile = userSnap.data();
            
            profileUsername.textContent = profile.username;
            profileHandle.textContent = `@${profile.username}`;
            profileUid.textContent = profile.uid;
            profileAvatar.src = profile.photoURL || `https://placehold.co/80x80/E0E7FF/4F46E5?text=${profile.username.charAt(0).toUpperCase()}`;
            profileFollowingCount.textContent = profile.followingCount || 0;
            profileFollowersCount.textContent = profile.followersCount || 0;

            if (userId === currentUser.uid) {
                currentFollowButton.classList.add('hidden');
            } else {
                currentFollowButton.classList.remove('hidden');
                const followRef = doc(db, "users", currentUser.uid, "following", userId);
                const followSnap = await getDoc(followRef);
                
                if (followSnap.exists()) {
                    currentFollowButton.textContent = 'Unfollow';
                    currentFollowButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    currentFollowButton.classList.add('bg-slate-500', 'hover:bg-slate-600');
                    currentFollowButton.dataset.following = 'true';
                } else {
                    currentFollowButton.textContent = 'Follow';
                    currentFollowButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    currentFollowButton.classList.remove('bg-slate-500', 'hover:bg-slate-600');
                    currentFollowButton.dataset.following = 'false';
                }
                
                const newFollowBtn = currentFollowButton.cloneNode(true);
                currentFollowButton.parentNode.replaceChild(newFollowBtn, currentFollowButton);
                
                newFollowBtn.addEventListener('click', () => {
                    const isFollowing = newFollowBtn.dataset.following === 'true';
                    if (isFollowing) {
                        unfollowUser(userId, profile.username, newFollowBtn); 
                    } else {
                        followUser(userId, profile.username, newFollowBtn);
                    }
                });
            }
            
            loadProfileFeed(userId);
        }

        async function followUser(targetUserId, targetUsername, button) {
            const currentUid = currentUser.uid;
            const currentUserRef = doc(db, "users", currentUid);
            const targetUserRef = doc(db, "users", targetUserId);
            
            const followingRef = doc(db, "users", currentUid, "following", targetUserId);
            const followerRef = doc(db, "users", targetUserId, "followers", currentUid);
            
            const batch = writeBatch(db);
            
            batch.set(followingRef, {
                username: targetUsername,
                followedAt: serverTimestamp()
            });
            batch.set(followerRef, {
                username: currentUserProfile.username,
                followedAt: serverTimestamp()
            });
            
            batch.update(currentUserRef, { followingCount: increment(1) });
            batch.update(targetUserRef, { followersCount: increment(1) });
            
            try {
                await batch.commit();
                button.textContent = 'Unfollow';
                button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.add('bg-slate-500', 'hover:bg-slate-600');
                button.dataset.following = 'true';
                profileFollowersCount.textContent = parseInt(profileFollowersCount.textContent) + 1;
                loadFollowingFeed(currentUid);
            } catch (error) {
                console.error("Error following user:", error);
            }
        }
        
        async function unfollowUser(targetUserId, targetUsername, button) {
            const currentUid = currentUser.uid;
            const currentUserRef = doc(db, "users", currentUid);
            const targetUserRef = doc(db, "users", targetUserId);
            
            const followingRef = doc(db, "users", currentUid, "following", targetUserId);
            const followerRef = doc(db, "users", targetUserId, "followers", currentUid);
            
            const batch = writeBatch(db);
            
            batch.delete(followingRef);
            batch.delete(followerRef);
            batch.update(currentUserRef, { followingCount: increment(-1) });
            batch.update(targetUserRef, { followersCount: increment(-1) });

            try {
                await batch.commit();
                button.textContent = 'Follow';
                button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.remove('bg-slate-500', 'hover:bg-slate-600');
                button.dataset.following = 'false';
                profileFollowersCount.textContent = parseInt(profileFollowersCount.textContent) - 1;
                loadFollowingFeed(currentUid);
            } catch (error) {
                console.error("Error unfollowing user:", error);
            }
        }

        // --- 11. DIRECT MESSAGES (NEW IMPLEMENTATION) ---

        // NEW: Reset chat view to its default state
        function resetChatView() {
            dmChatView.classList.add('hidden');
            dmChatPlaceholder.classList.remove('hidden');
            dmChatHeader.textContent = 'Select a conversation';
            dmInput.disabled = true;
            dmFormButton.disabled = true;
            dmInput.placeholder = 'Select a conversation to message...';
            messageLog.innerHTML = '';
            currentChatPartner = null;
            if (unsubscribeConversation) unsubscribeConversation();
            unsubscribeConversation = null;
        }

        // NEW: Load the list of users the current user is following
        async function loadConversationList() {
            if (!currentUser) return;

            dmConversationList.innerHTML = '<p class="p-4 text-gray-500">Loading following list...</p>';

            const followingCol = collection(db, "users", currentUser.uid, "following");
            const followingSnapshot = await getDocs(followingCol);

            if (followingSnapshot.empty) {
                dmConversationList.innerHTML = '<p class="p-4 text-gray-500">Follow people to message them. Check the Discover tab!</p>';
                return;
            }

            dmConversationList.innerHTML = ''; // Clear loading
            followingSnapshot.forEach(doc => {
                const partnerId = doc.id;
                const partnerUsername = doc.data().username;
                
                const userElement = document.createElement('div');
                userElement.className = "p-4 border-b border-gray-200 cursor-pointer hover:bg-slate-100";
                userElement.textContent = partnerUsername;
                userElement.dataset.userId = partnerId;
                userElement.dataset.username = partnerUsername;
                
                userElement.onclick = () => {
                    // Highlight this user
                    Array.from(dmConversationList.children).forEach(child => {
                        child.classList.remove('bg-indigo-100', 'font-semibold');
                    });
                    userElement.classList.add('bg-indigo-100', 'font-semibold');
                    
                    // Open the conversation
                    openConversation(partnerId, partnerUsername);
                };
                
                dmConversationList.appendChild(userElement);
            });
        }

        // NEW: Open a specific conversation
        function openConversation(partnerId, partnerUsername) {
            currentChatPartner = { uid: partnerId, username: partnerUsername };
            
            // Update UI
            dmChatView.classList.remove('hidden');
            dmChatPlaceholder.classList.add('hidden');
            dmChatHeader.textContent = `Chat with ${partnerUsername}`;
            dmInput.disabled = false;
            dmFormButton.disabled = false;
            dmInput.placeholder = `Message ${partnerUsername}...`;
            
            // Generate a unique, consistent conversation ID
            const convoId = [currentUser.uid, partnerId].sort().join('_');
            
            // Load messages
            loadConversationMessages(convoId);
        }

        // NEW: Load messages for a specific conversation
        function loadConversationMessages(convoId) {
            if (unsubscribeConversation) unsubscribeConversation();

            const q = query(collection(db, "conversations", convoId, "messages"), orderBy("createdAt", "asc"), limit(100));
            
            unsubscribeConversation = onSnapshot(q, (snapshot) => {
                messageLog.innerHTML = ''; // Clear
                if (snapshot.empty) {
                    messageLog.innerHTML = '<p class="text-gray-500 text-center p-4">No messages yet. Say hi!</p>';
                    return;
                }
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const msgElement = document.createElement('div');
                    
                    const text = document.createElement('p');
                    text.textContent = msg.text;
                    msgElement.appendChild(text);

                    // Differentiate sender
                    if (msg.senderId === currentUser.uid) {
                        msgElement.className = "p-3 rounded-lg max-w-xs mb-2 bg-indigo-600 text-white ml-auto";
                    } else {
                        msgElement.className = "p-3 rounded-lg max-w-xs mb-2 bg-slate-200 text-gray-800 mr-auto";
                    }
                    
                    messageLog.appendChild(msgElement);
                });
                messageLog.scrollTop = messageLog.scrollHeight;
            }, (error) => {
                console.error("Error loading messages:", error);
                messageLog.innerHTML = '<p class="text-red-500 text-center">Error loading messages.</p>';
            });
        }


        // MODIFIED: DM form now sends to the /conversations collection
        dmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = dmInput.value.trim();
            
            // Check if a chat is active
            if (!text || !currentUser || !currentChatPartner) return;
            
            dmInput.value = ''; // Optimistic clear
            
            // Get the same consistent ID
            const convoId = [currentUser.uid, currentChatPartner.uid].sort().join('_');

            // Get refs
            const convoDocRef = doc(db, "conversations", convoId);
            const messagesColRef = collection(convoDocRef, "messages");

            const batch = writeBatch(db);

            try {
                // 1. Set/update the parent conversation doc (for metadata)
                batch.set(convoDocRef, {
                    members: [currentUser.uid, currentChatPartner.uid],
                    memberInfo: {
                        [currentUser.uid]: { username: currentUserProfile.username },
                        [currentChatPartner.uid]: { username: currentChatPartner.username }
                    },
                    lastMessage: text,
                    lastMessageAt: serverTimestamp(),
                    lastMessageSenderId: currentUser.uid
                }, { merge: true }); // Use merge to not overwrite

                // 2. Add the new message to the subcollection
                const newMessageRef = doc(messagesColRef); // Auto-generate ID
                batch.set(newMessageRef, {
                    text: text,
                    senderId: currentUser.uid,
                    senderUsername: currentUserProfile.username,
                    createdAt: serverTimestamp()
                });

                await batch.commit();
                
            } catch (error) {
                console.error("DM Send Error:", error);
                alert(`Error sending message: ${error.message}`);
                dmInput.value = text; // Put text back on error
            }
        });

        // --- 12. APP NAVIGATION (TABS) ---
        
        const navLinks = document.querySelectorAll('.nav-link');
        const contentPanels = document.querySelectorAll('.content-panel');
        const sidebarPostButton = document.getElementById('sidebar-post-button');

        function navigateTo(targetId) {
             // Update Nav Link styles
            navLinks.forEach(nav => {
                if (nav.dataset.target === targetId) {
                    nav.classList.add('font-semibold', 'text-gray-800', 'bg-slate-100');
                    nav.classList.remove('font-medium', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-slate-50');
                } else {
                    nav.classList.remove('font-semibold', 'text-gray-800', 'bg-slate-100');
                    nav.classList.add('font-medium', 'text-gray-600', 'hover:text-indigo-600', 'hover:bg-slate-50');
                }
            });

            // Show/Hide Content Panels
            contentPanels.forEach(panel => {
                if (panel.id === targetId) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });

            // Stop any profile feed listeners if we navigate away
            if (targetId !== 'content-profile' && unsubscribeProfileFeed) {
                unsubscribeProfileFeed();
                unsubscribeProfileFeed = null;
            }

            // *** NEW DM NAVIGATION LOGIC ***
            if (targetId === 'content-messages') {
                loadConversationList();
                resetChatView(); // Reset to default state
            } else if (unsubscribeConversation) {
                // We are navigating *away* from messages, so clean up
                unsubscribeConversation();
                unsubscribeConversation = null;
                currentChatPartner = null;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded. Attaching nav listeners.");

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.dataset.target;
                    
                    if (targetId === 'content-profile') {
                        showProfile(currentUser.uid);
                    } else {
                        navigateTo(targetId);
                    }
                });
            });

            sidebarPostButton.addEventListener('click', () => {
                navigateTo('content-home');
                postTextarea.focus();
            });

            sidebarProfileButton.addEventListener('click', () => {
                showProfile(currentUser.uid);
            });
        });

    </script>

    <script>
    function showInlineError(msg, targetId) {
      const id = targetId || 'auth-error';
      const el = document.getElementById(id);
      if (el) {
        el.textContent = msg;
      } else {
        console.error('Error:', msg);
        alert(msg);
      }
    }
    </script>
</body>
</html>
